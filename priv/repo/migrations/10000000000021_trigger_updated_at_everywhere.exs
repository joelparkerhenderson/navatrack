defmodule Navatrack.Repo.Migrations.TriggerUpdatedAtEverywhere do
  use Ecto.Migration

  def up do
    execute """
    DO $$
    DECLARE
        table_record RECORD;
    BEGIN
        FOR table_record IN
            SELECT table_name
            FROM information_schema.columns
            WHERE column_name = 'updated_at'
            AND table_schema = 'public'
        LOOP
            EXECUTE format('
                CREATE TRIGGER trigger_%I_updated_at
                  BEFORE UPDATE ON %I
                    FOR EACH ROW
                    EXECUTE FUNCTION trigger_updated_at();
            ', table_record.table_name, table_record.table_name);
        END LOOP;
    END $$;
    """
  end

  def down do
    execute """
    DO $$
    DECLARE
        table_record RECORD;
    BEGIN
        FOR table_record IN
            SELECT table_name
            FROM information_schema.columns
            WHERE column_name = 'updated_at'
            AND table_schema = 'public'
        LOOP
            EXECUTE format('
                DROP TRIGGER IF EXISTS trigger_%I_updated_at;
            ', table_record.table_name);
        END LOOP;
    END $$;
    """
  end
end
